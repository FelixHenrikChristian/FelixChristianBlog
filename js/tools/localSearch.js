let isFetched=!1,cachedData=[],cachedPath=null,isXml=!0,didInit=!1,warnedMissing=!1,resolveSearchPath=()=>{var e=config.path;if(!e)return null;let t=e;return isXml=!0,0===t.length?t="search.xml":t.endsWith("json")&&(isXml=!1),cachedPath=t},ensureSearchPath=()=>cachedPath||resolveSearchPath(),normalizeData=e=>e.filter(e=>e.title).map(e=>(e.title=e.title.trim(),e.content=e.content?e.content.trim().replace(/<[^>]+>/g,""):"",e.url=decodeURIComponent(e.url).replace(/\/{2,}/g,"/"),e)),fetchData=()=>{!isFetched&&cachedPath&&fetch(config.root+cachedPath).then(e=>e.text()).then(e=>{isFetched=!0,cachedData=isXml?[...(new DOMParser).parseFromString(e,"text/xml").querySelectorAll("entry")].map(e=>({title:e.querySelector("title").textContent,content:e.querySelector("content").textContent,url:e.querySelector("url").textContent})):JSON.parse(e),cachedData=normalizeData(cachedData);e=document.querySelector("#no-result");e&&(e.innerHTML='<i class="fa-solid fa-magnifying-glass fa-5x"></i>')}).catch(e=>{console.error("Failed to load search data:",e)})},getSearchDom=()=>({searchInputDom:document.querySelector(".search-input"),resultContent:document.getElementById("search-result"),overlay:document.querySelector(".search-pop-overlay")}),closePopup=()=>{var e=getSearchDom().overlay;e&&(document.body.style.overflow="",e.classList.remove("active"))},openPopup=()=>{let{overlay:e,searchInputDom:t}=getSearchDom();e&&t&&(document.body.style.overflow="hidden",e.classList.add("active"),setTimeout(()=>t.focus(),500),isFetched||fetchData())},getIndexByWord=(e,t,n)=>{var a=e.length;if(0===a)return[];let r=0;var o,l=[];for(n||(t=t.toLowerCase(),e=e.toLowerCase());-1<(o=t.indexOf(e,r));)l.push({position:o,word:e}),r=o+a;return l},mergeIntoSlice=(e,t,n,a)=>{var r;let{position:o,word:l}=n[n.length-1];var s=[];let i=0;for(;o+l.length<=t&&0!==n.length;){l===a&&i++,s.push({position:o,length:l.length});var h=o+l.length;n.pop();for(let e=n.length-1;0<=e&&(r=n[e],o=r.position,l=r.word,!(h<=o));e--)n.pop()}return{hits:s,start:e,end:t,searchTextCount:i}},highlightKeyword=(n,e)=>{let a="",r=e.start;return e.hits.forEach(e=>{a+=n.substring(r,e.position);var t=e.position+e.length;a+=`<b class="search-keyword">${n.substring(e.position,t)}</b>`,r=t}),a+=n.substring(r,e.end)},renderSearchResult=e=>{if(isFetched&&e){var n=getSearchDom().resultContent;if(n){let g=e.value.trim().toLowerCase(),p=g.split(/[-\s]+/),m=(1<p.length&&p.push(g),[]);if(0<g.length&&cachedData.forEach(({title:e,content:a,url:r})=>{let t=e.toLowerCase(),n=a.toLowerCase(),o=[],l=[],s=0;if(p.forEach(e=>{o=o.concat(getIndexByWord(e,t,!1)),l=l.concat(getIndexByWord(e,n,!1))}),0<o.length||0<l.length){var i=o.length+l.length,h=([o,l].forEach(e=>{e.sort((e,t)=>t.position!==e.position?t.position-e.position:e.word.length-t.word.length)}),[]);0!==o.length&&(u=mergeIntoSlice(0,e.length,o,g),s+=u.searchTextCountInSlice,h.push(u));let n=[];for(;0!==l.length;){var{position:c,word:d}=l[l.length-1];let e=c-20,t=c+80;e<0&&(e=0),(t=t<c+d.length?c+d.length:t)>a.length&&(t=a.length);c=mergeIntoSlice(e,t,l,g);s+=c.searchTextCountInSlice,n.push(c)}n.sort((e,t)=>e.searchTextCount!==t.searchTextCount?t.searchTextCount-e.searchTextCount:e.hits.length!==t.hits.length?t.hits.length-e.hits.length:e.start-t.start);var u=parseInt(theme.navbar.search.top_n_per_article||1,10);0<=u&&(n=n.slice(0,u));let t="";t+=0!==h.length?`<li><a href="${r}" class="search-result-title">${highlightKeyword(e,h[0])}</a>`:`<li><a href="${r}" class="search-result-title">${e}</a>`,n.forEach(e=>{t+=`<a href="${r}"><p class="search-result">${highlightKeyword(a,e)}...</p></a>`}),t+="</li>",m.push({item:t,id:m.length,hitCount:i,searchTextCount:s})}}),1===p.length&&""===p[0])n.innerHTML='<div id="no-result"><i class="fa-solid fa-magnifying-glass fa-5x"></i></div>';else if(0===m.length)n.innerHTML='<div id="no-result"><i class="fa-solid fa-box-open fa-5x"></i></div>';else{m.sort((e,t)=>e.searchTextCount!==t.searchTextCount?t.searchTextCount-e.searchTextCount:e.hitCount!==t.hitCount?t.hitCount-e.hitCount:t.id-e.id);let t='<ul class="search-result-list">';m.forEach(e=>{t+=e.item}),t+="</ul>",n.innerHTML=t,window.pjax&&window.pjax.refresh(n)}}}},handleInput=e=>{e.target.matches(".search-input")&&renderSearchResult(e.target)},handleClick=e=>{var t;e.target.closest(".search-popup-trigger")?openPopup():(t=e.target.closest(".search-pop-overlay"))&&e.target===t?closePopup():e.target.closest(".search-input-field-pre")?(t=getSearchDom().searchInputDom,t&&(t.value="",t.focus(),renderSearchResult(t))):e.target.closest(".popup-btn-close")&&closePopup()},handleKeyup=e=>{"Escape"===e.key&&closePopup()},initLocalSearchGlobals=({signal:e}={})=>{ensureSearchPath()?didInit||(didInit=!0,e?(document.addEventListener("input",handleInput,{signal:e}),document.addEventListener("click",handleClick,{signal:e}),window.addEventListener("keyup",handleKeyup,{signal:e})):(document.addEventListener("input",handleInput),document.addEventListener("click",handleClick),window.addEventListener("keyup",handleKeyup))):warnedMissing||(console.warn("`hexo-generator-searchdb` plugin is not installed!"),warnedMissing=!0)},initLocalSearchPage=()=>{ensureSearchPath()?(closePopup(),theme.navbar?.search?.preload&&fetchData()):warnedMissing||(console.warn("`hexo-generator-searchdb` plugin is not installed!"),warnedMissing=!0)};export{initLocalSearchGlobals,initLocalSearchPage};