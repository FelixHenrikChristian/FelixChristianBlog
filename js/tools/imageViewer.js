let viewerState={isBigImage:!1,scale:1,fitScale:1,userZoomed:!1,isMouseDown:!1,dragged:!1,currentImgIndex:0,lastMouseX:0,lastMouseY:0,translateX:0,translateY:0,maskDom:null,targetImg:null},imageSelector=".markdown-body img, .masonry-item img, #shuoshuo-content img",viewerControls={prevButton:null,nextButton:null,closeButton:null},exifControls={toggleButton:null,panel:null,cardsContainer:null,closeButton:null,cardTemplate:null,requestId:0},getI18nValue=e=>{if(!e)return null;var t,e=String(e).split(".").filter(Boolean);let a=window.i18n;for(t of e){if(!a||"object"!=typeof a)return null;a=a[t]}return a??null},t=(e,t="")=>{e=getI18nValue(e);return"string"==typeof e?e:null!=e?String(e):t},imageNodes=[],didInitKeys=!1,applyTransform=()=>{viewerState.targetImg&&(viewerState.targetImg.style.transform=`translate(${viewerState.translateX}px, ${viewerState.translateY}px) scale(${viewerState.scale})`)},getFrameRect=()=>viewerState.maskDom?(viewerState.maskDom.querySelector(".image-viewer-frame")||viewerState.maskDom).getBoundingClientRect():null,fitToViewport=(e={})=>{var t;viewerState.targetImg&&getFrameRect()&&(e=e.marginFactor??.98,viewerState.scale=1,viewerState.translateX=0,viewerState.translateY=0,applyTransform(),(t=viewerState.targetImg.getBoundingClientRect()).width)&&t.height&&(e=window.innerHeight*e,e=Math.min(1,e/t.height,window.innerWidth/t.width),viewerState.fitScale=e,viewerState.scale=e,viewerState.translateX=0,viewerState.translateY=0,viewerState.userZoomed=!1,applyTransform())},resetTransform=()=>{fitToViewport()},showHandle=e=>{viewerState.maskDom&&(document.body.style.overflow=e?"hidden":"auto",viewerState.maskDom.classList.toggle("active",e))},closeViewer=()=>{viewerState.isBigImage&&(viewerState.isBigImage=!1,showHandle(!1),resetTransform(),viewerState.userZoomed=!1,resetExifUI())},updateImageNodes=()=>{imageNodes=Array.from(document.querySelectorAll(imageSelector))},canGoPrev=()=>0<viewerState.currentImgIndex,canGoNext=()=>viewerState.currentImgIndex<Math.max(imageNodes.length-1,0),updateNavButtons=()=>{viewerControls.prevButton&&viewerControls.nextButton&&(viewerControls.prevButton.classList.toggle("is-disabled",!canGoPrev()),viewerControls.nextButton.classList.toggle("is-disabled",!canGoNext()))},hasExifFlag=e=>"true"===e?.dataset?.exif,resolveExifImageUrl=t=>{if(!t)return null;t=t.getAttribute("data-src")||t.currentSrc||t.src;if(!t)return null;try{return new URL(t,window.location.href).toString()}catch(e){return t}},formatExifValue=e=>{if(!e)return null;if("object"==typeof e){if(null!=e.description)return String(e.description).trim();if(null!=e.value)return(Array.isArray(e.value)?e.value.map(e=>String(e)).join(", "):String(e.value)).trim()}return("string"==typeof e?e:String(e)).trim()},getExifValueByKeys=(e,t=[])=>{if(e&&Array.isArray(t))for(var a of t){a=formatExifValue(e[a]);if(a)return a}return null},parseRational=e=>{if("number"==typeof e)return Number.isFinite(e)?e:null;if(e&&"object"==typeof e){var t=e.numerator??e.num,a=e.denominator??e.den;if(Number.isFinite(t)&&Number.isFinite(a)&&0!==a)return t/a;if(Number.isFinite(e.value))return e.value}return"string"==typeof e&&(t=Number.parseFloat(e),Number.isFinite(t))?t:null},resolveTagRawValue=e=>e?"object"==typeof e&&"value"in e?e.value:e:null,formatGpsCoordinate=(e,t,a)=>{if(!e)return null;t=e[t];if(!t)return null;var i,r,l=resolveTagRawValue(t),e=formatExifValue(e[a]);let n=null;return Array.isArray(l)?3<=(a=l.map(parseRational).filter(e=>null!=e)).length&&([a,i,r]=a,n=a+i/60+r/3600):n=parseRational(l),null==n?(a=formatExifValue(t))?e&&!a.includes(e)?a+" "+e:a:null:(i=e?String(e).trim().toUpperCase():"",r=Math.abs(n).toFixed(4),i?r+" "+i:n.toFixed(4))},buildExifGroups=e=>{if(!e)return[];let i=[];var a=(e,t,a)=>{a=(a||[]).filter(Boolean);0!==a.length&&i.push({title:e,icon:t,items:a})},r=getExifValueByKeys(e,["Make"]),l=getExifValueByKeys(e,["Model"]),n=getExifValueByKeys(e,["DateTimeOriginal","DateTime"]),r=(a(t("exif.cards.camera","Camera"),"fa-solid fa-camera",[r&&{label:t("exif.fields.make","Brand"),value:r},l&&{label:t("exif.fields.model","Model"),value:l},n&&{label:t("exif.fields.date_taken","Date taken"),value:n}]),getExifValueByKeys(e,["LensModel","Lens","LensSpecification"])),l=getExifValueByKeys(e,["FocalLength","FocalLengthIn35mmFilm"]),n=getExifValueByKeys(e,["FocusMode","AFMode","AFAreaMode","FocusingMode","AutoFocus","FocusMethod"]),r=(a(t("exif.cards.lens","Lens"),"fa-solid fa-eye",[r&&{label:t("exif.fields.lens_model","Lens"),value:r},l&&{label:t("exif.fields.focal_length","Focal length"),value:l},n&&{label:t("exif.fields.focus_mode","Focus mode"),value:n}]),getExifValueByKeys(e,["ExposureTime"])),l=getExifValueByKeys(e,["FNumber"]),n=getExifValueByKeys(e,["ISO","PhotographicSensitivity"]),o=getExifValueByKeys(e,["ExposureProgram"]),s=getExifValueByKeys(e,["ExposureBiasValue"]),d=getExifValueByKeys(e,["MeteringMode"]),r=(a(t("exif.cards.exposure","Exposure"),"fa-solid fa-sun",[r&&{label:t("exif.fields.shutter","Shutter"),value:r},l&&{label:t("exif.fields.aperture","Aperture"),value:l},n&&{label:t("exif.fields.iso","ISO"),value:n},o&&{label:t("exif.fields.exposure_program","Exposure program"),value:o},s&&{label:t("exif.fields.exposure_compensation","Exposure compensation"),value:s},d&&{label:t("exif.fields.metering_mode","Metering mode"),value:d}]),getExifValueByKeys(e,["Flash"])),l=getExifValueByKeys(e,["WhiteBalance"]),n=formatGpsCoordinate(e,"GPSLatitude","GPSLatitudeRef"),o=formatGpsCoordinate(e,"GPSLongitude","GPSLongitudeRef"),s=getExifValueByKeys(e,["GPSAltitude"]);return a(t("exif.cards.other","Other"),"fa-solid fa-gear",[r&&{label:t("exif.fields.flash","Flash"),value:r},l&&{label:t("exif.fields.white_balance","White balance"),value:l},n&&{label:t("exif.fields.latitude","Latitude"),value:n},o&&{label:t("exif.fields.longitude","Longitude"),value:o},s&&{label:t("exif.fields.altitude","Altitude"),value:s}]),i},setExifPanelOpen=e=>{exifControls.panel&&exifControls.toggleButton&&(exifControls.panel.classList.toggle("hidden",!e),exifControls.panel.setAttribute("aria-hidden",e?"false":"true"),exifControls.toggleButton.setAttribute("aria-expanded",e?"true":"false"))},clearExifCards=()=>{exifControls.cardsContainer&&(exifControls.cardsContainer.innerHTML="")},createExifItem=(e,t)=>{var a=document.createElement("div"),i=(a.className="image-viewer-exif-item flex items-start justify-between gap-2",document.createElement("div")),e=(i.className="image-viewer-exif-item-label text-[0.65rem] uppercase tracking-wide shrink-0 text-third-text-color",i.textContent=e,document.createElement("div"));return e.className="image-viewer-exif-item-value text-[0.65rem] text-first-text-color text-right",e.textContent=t,a.appendChild(i),a.appendChild(e),a},createExifCard=e=>{var i=exifControls.cardTemplate?.content?.firstElementChild;let r=i?i.cloneNode(!0):null;if(!r){(r=document.createElement("div")).className="rounded-lg border border-border-color bg-background-color-transparent-80 px-3 py-2 shadow-redefine-flat";var i=document.createElement("div");i.className="image-viewer-exif-card-header flex items-center gap-2 mb-1";let e=document.createElement("i"),t=(e.className="image-viewer-exif-card-icon fa-solid fa-circle-info text-xs text-third-text-color",document.createElement("div")),a=(t.className="image-viewer-exif-card-title text-xs font-semibold text-first-text-color",i.appendChild(e),i.appendChild(t),document.createElement("div"));a.className="image-viewer-exif-card-items flex flex-col gap-1",r.appendChild(i),r.appendChild(a)}let t=r.querySelector(".image-viewer-exif-card-title"),a=r.querySelector(".image-viewer-exif-card-icon"),l=r.querySelector(".image-viewer-exif-card-items");return l||((l=document.createElement("div")).className="image-viewer-exif-card-items flex flex-col gap-1",r.appendChild(l)),t&&(t.textContent=e.title),a&&(i=e.icon||"fa-solid fa-circle-info",a.className=`image-viewer-exif-card-icon ${i} text-xs text-third-text-color`),l.innerHTML="",e.items.forEach(e=>{l.appendChild(createExifItem(e.label,e.value))}),r},renderExifGroups=e=>{if(exifControls.cardsContainer){clearExifCards();var e=Array.isArray(e)?e.map(e=>{var t,a;return e&&"object"==typeof e&&(t=String(e.title||"").trim(),a=String(e.icon||"").trim(),e=Array.isArray(e.items)?e.items.map(e=>{var t;return e&&"object"==typeof e&&(t=String(e.label||"").trim(),e=String(e.value??"").trim(),t)&&e?{label:t,value:e}:null}).filter(Boolean):[],t)&&0!==e.length?{title:t,icon:a,items:e}:null}).filter(Boolean):[],i=t("exif.title","EXIF"),e=e.length?e:[{title:i,icon:"fa-solid fa-circle-info",items:[{label:i,value:t("exif.status.no_exif","No EXIF available")}]}];let a=document.createDocumentFragment();e.forEach(e=>{a.appendChild(createExifCard(e))}),exifControls.cardsContainer.appendChild(a)}},bumpExifRequestId=()=>(exifControls.requestId=(exifControls.requestId||0)+1,exifControls.requestId),renderExifMessage=e=>{var a=t("exif.title","EXIF");renderExifGroups([{title:a,icon:"fa-solid fa-circle-info",items:[{label:a,value:e}]}])},loadExifForImage=async e=>{var a=bumpExifRequestId(),i=(renderExifMessage(t("exif.status.loading","Loading...")),window.ExifReader);if(!i||"function"!=typeof i.load)return exifControls.requestId!==a?void 0:void renderExifMessage(t("exif.status.library_missing","EXIF library not loaded"));e=resolveExifImageUrl(e);if(!e)return exifControls.requestId!==a?void 0:void renderExifMessage(t("exif.status.image_source_missing","Image source unavailable"));try{var r,l=await i.load(e);exifControls.requestId===a&&(0===(r=buildExifGroups(l)).length?renderExifMessage(t("exif.status.no_exif","No EXIF available")):renderExifGroups(r))}catch(e){exifControls.requestId===a&&renderExifMessage(t("exif.status.unavailable","EXIF unavailable (blocked by CORS or missing metadata)"))}},updateExifUI=e=>{e=hasExifFlag(e);bumpExifRequestId(),exifControls.toggleButton&&(exifControls.toggleButton.classList.toggle("hidden",!e),exifControls.toggleButton.disabled=!e),setExifPanelOpen(!1),clearExifCards()},resetExifUI=()=>{bumpExifRequestId(),exifControls.toggleButton&&(exifControls.toggleButton.classList.add("hidden"),exifControls.toggleButton.setAttribute("aria-expanded","false")),setExifPanelOpen(!1),clearExifCards()},updateViewerImage=a=>{var i=imageNodes[a];if(i&&viewerState.targetImg){viewerState.currentImgIndex=a;let e=i.src,t=(i.hasAttribute("lazyload")&&((e=i.getAttribute("data-src")||e)&&(i.src=e),i.removeAttribute("lazyload")),e&&(viewerState.targetImg.src=e),viewerState.targetImg.alt=i.alt||"",()=>{viewerState.targetImg?.removeEventListener("load",t),fitToViewport()});viewerState.targetImg.complete?fitToViewport():viewerState.targetImg.addEventListener("load",t,{once:!0}),updateNavButtons(),updateExifUI(i)}},goPrev=()=>{viewerState.isBigImage&&canGoPrev()&&updateViewerImage(viewerState.currentImgIndex-1)},goNext=()=>{viewerState.isBigImage&&canGoNext()&&updateViewerImage(viewerState.currentImgIndex+1)},handleArrowKeys=e=>{viewerState.isBigImage&&("Escape"===e.key?(e.preventDefault(),closeViewer()):"ArrowUp"===e.key||"ArrowLeft"===e.key?(e.preventDefault(),goPrev()):"ArrowDown"!==e.key&&"ArrowRight"!==e.key||(e.preventDefault(),goNext()))},registerGlobalHandlers=e=>{didInitKeys||(didInitKeys=!0,e?document.addEventListener("keydown",handleArrowKeys,{signal:e}):document.addEventListener("keydown",handleArrowKeys))};export default function initImageViewer({signal:e,appSignal:a}={}){let i=document.querySelector(".image-viewer-container");if(!i)return void console.warn("Image viewer container not found. Exiting imageViewer function.");var r=i.querySelector("img");if(!r)return void console.warn("Target image not found in image viewer container. Exiting imageViewer function.");viewerState.maskDom=i,viewerState.targetImg=r,viewerState.dragged=!1,viewerControls.prevButton=i.querySelector(".image-viewer-prev"),viewerControls.nextButton=i.querySelector(".image-viewer-next"),viewerControls.closeButton=i.querySelector(".image-viewer-close"),exifControls.toggleButton=i.querySelector(".image-viewer-exif-toggle"),exifControls.panel=i.querySelector(".image-viewer-exif-panel"),exifControls.cardsContainer=i.querySelector(".image-viewer-exif-cards"),exifControls.closeButton=i.querySelector(".image-viewer-exif-close"),exifControls.cardTemplate=i.querySelector(".image-viewer-exif-card-template"),updateImageNodes(),registerGlobalHandlers(a),updateNavButtons(),resetExifUI();var a=e=>{var t,a,i,r,l;e.ctrlKey&&(e.preventDefault(),viewerState.targetImg)&&(a=viewerState.targetImg.getBoundingClientRect(),t=e.clientX-a.left-a.width/2,a=e.clientY-a.top-a.height/2,i=viewerState.scale,r=Math.max(.2,.8*viewerState.fitScale),l=Math.min(8,4*viewerState.fitScale),viewerState.scale+=-.001*e.deltaY,viewerState.scale=Math.min(Math.max(r,viewerState.scale),l),viewerState.userZoomed=.01<Math.abs(viewerState.scale-viewerState.fitScale),i<viewerState.scale?(viewerState.translateX-=t*(viewerState.scale-i),viewerState.translateY-=a*(viewerState.scale-i)):(viewerState.translateX=0,viewerState.translateY=0),applyTransform())},l=e=>{viewerState.scale<=viewerState.fitScale+.01||(e.preventDefault(),viewerState.isMouseDown=!0,viewerState.lastMouseX=e.clientX,viewerState.lastMouseY=e.clientY,o=e.clientX,s=e.clientY,viewerState.targetImg.style.cursor="grabbing",viewerState.userZoomed=!0)};let n=null,o=null,s=null;var d=e=>{!viewerState.isMouseDown||viewerState.scale<=viewerState.fitScale+.01||(o=e.clientX,s=e.clientY,null===n&&(n=window.requestAnimationFrame(()=>{var e,t;n=(null==o||null==s||(e=o-viewerState.lastMouseX,t=s-viewerState.lastMouseY,viewerState.translateX+=e,viewerState.translateY+=t,viewerState.lastMouseX=o,viewerState.lastMouseY=s,applyTransform(),viewerState.dragged=!0),null)})))},u=e=>{viewerState.isMouseDown&&e.stopPropagation(),viewerState.isMouseDown=!1,null!==n&&(window.cancelAnimationFrame(n),n=null),o=null,s=null,viewerState.dragged&&window.setTimeout(()=>{viewerState.dragged=!1},0),viewerState.targetImg.style.cursor="grab"},g=e=>{var e=e.target.closest(imageSelector);e&&!e.closest(".image-viewer-container")&&(updateImageNodes(),e=imageNodes.indexOf(e),viewerState.isBigImage=!0,viewerState.dragged=!1,viewerState.userZoomed=!1,showHandle(!0),updateViewerImage(-1===e?0:e))},f=e=>{var t;viewerState.dragged||(e=e.target).closest(".image-viewer-prev, .image-viewer-next, .image-viewer-close, .image-viewer-exif-panel, .image-viewer-exif-toggle")||!e.closest(".image-viewer-frame img")&&(t=i.querySelector(".image-viewer-frame"),e===i||t&&e===t)&&closeViewer()},c=e=>{e.stopPropagation(),goPrev()},v=e=>{e.stopPropagation(),goNext()},m=e=>{e.stopPropagation(),closeViewer()},x=e=>{e.stopPropagation(),exifControls.panel&&(!exifControls.panel.classList.contains("hidden")?setExifPanelOpen(!1):(setExifPanelOpen(!0),e=imageNodes[viewerState.currentImgIndex],hasExifFlag(e)?loadExifForImage(e):renderExifMessage(t("exif.status.flag_unavailable","EXIF unavailable"))))},w=e=>{e.stopPropagation(),setExifPanelOpen(!1)},p=()=>{viewerState.isBigImage&&!viewerState.userZoomed&&fitToViewport()};e?(r.addEventListener("wheel",a,{passive:!1,signal:e}),r.addEventListener("mousedown",l,{passive:!1,signal:e}),r.addEventListener("mousemove",d,{passive:!1,signal:e}),r.addEventListener("mouseup",u,{passive:!1,signal:e}),r.addEventListener("mouseleave",u,{passive:!1,signal:e}),i.addEventListener("click",f,{signal:e}),window.addEventListener("resize",p,{signal:e}),document.addEventListener("click",g,{signal:e}),viewerControls.prevButton?.addEventListener("click",c,{signal:e}),viewerControls.nextButton?.addEventListener("click",v,{signal:e}),viewerControls.closeButton?.addEventListener("click",m,{signal:e}),exifControls.toggleButton?.addEventListener("click",x,{signal:e}),exifControls.closeButton?.addEventListener("click",w,{signal:e})):(r.addEventListener("wheel",a,{passive:!1}),r.addEventListener("mousedown",l,{passive:!1}),r.addEventListener("mousemove",d,{passive:!1}),r.addEventListener("mouseup",u,{passive:!1}),r.addEventListener("mouseleave",u,{passive:!1}),i.addEventListener("click",f),window.addEventListener("resize",p),document.addEventListener("click",g),viewerControls.prevButton?.addEventListener("click",c),viewerControls.nextButton?.addEventListener("click",v),viewerControls.closeButton?.addEventListener("click",m),exifControls.toggleButton?.addEventListener("click",x),exifControls.closeButton?.addEventListener("click",w))}