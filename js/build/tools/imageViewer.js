let e={isBigImage:!1,scale:1,fitScale:1,userZoomed:!1,isMouseDown:!1,dragged:!1,currentImgIndex:0,lastMouseX:0,lastMouseY:0,translateX:0,translateY:0,maskDom:null,targetImg:null},i=".markdown-body img, .masonry-item img, #shuoshuo-content img",n={prevButton:null,nextButton:null,closeButton:null},a={toggleButton:null,panel:null,cardsContainer:null,closeButton:null,cardTemplate:null,requestId:0},t=(e,t="")=>{e=(e=>{if(!e)return null;var t=String(e).split(".").filter(Boolean);let a=window.i18n;for(let e of t){if(!a||"object"!=typeof a)return null;a=a[e]}return a??null})(e);return"string"==typeof e?e:null!=e?String(e):t},r=[],l=!1,applyTransform=()=>{e.targetImg&&(e.targetImg.style.transform=`translate(${e.translateX}px, ${e.translateY}px) scale(${e.scale})`)},fitToViewport=(t={})=>{var a;e.targetImg&&(e.maskDom?(e.maskDom.querySelector(".image-viewer-frame")||e.maskDom).getBoundingClientRect():null)&&(t=t.marginFactor??.98,e.scale=1,e.translateX=0,e.translateY=0,applyTransform(),(a=e.targetImg.getBoundingClientRect()).width)&&a.height&&(t=window.innerHeight*t,t=Math.min(1,t/a.height,window.innerWidth/a.width),e.fitScale=t,e.scale=t,e.translateX=0,e.translateY=0,e.userZoomed=!1,applyTransform())},showHandle=t=>{e.maskDom&&(document.body.style.overflow=t?"hidden":"auto",e.maskDom.classList.toggle("active",t))},closeViewer=()=>{e.isBigImage&&(e.isBigImage=!1,showHandle(!1),fitToViewport(),e.userZoomed=!1,resetExifUI())},updateImageNodes=()=>{r=Array.from(document.querySelectorAll(i))},canGoPrev=()=>0<e.currentImgIndex,canGoNext=()=>e.currentImgIndex<Math.max(r.length-1,0),updateNavButtons=()=>{n.prevButton&&n.nextButton&&(n.prevButton.classList.toggle("is-disabled",!canGoPrev()),n.nextButton.classList.toggle("is-disabled",!canGoNext()))},hasExifFlag=e=>"true"===e?.dataset?.exif,formatExifValue=e=>{if(!e)return null;if("object"==typeof e){if(null!=e.description)return String(e.description).trim();if(null!=e.value)return(Array.isArray(e.value)?e.value.map(e=>String(e)).join(", "):String(e.value)).trim()}return("string"==typeof e?e:String(e)).trim()},getExifValueByKeys=(t,e=[])=>{if(t&&Array.isArray(e))for(var a of e){let e=formatExifValue(t[a]);if(e)return e}return null},parseRational=e=>{if("number"==typeof e)return Number.isFinite(e)?e:null;if(e&&"object"==typeof e){var t=e.numerator??e.num,a=e.denominator??e.den;if(Number.isFinite(t)&&Number.isFinite(a)&&0!==a)return t/a;if(Number.isFinite(e.value))return e.value}return"string"==typeof e&&(t=Number.parseFloat(e),Number.isFinite(t))?t:null},formatGpsCoordinate=(e,t,a)=>{if(!e)return null;let i=e[t];if(!i)return null;t=(t=i)?"object"==typeof t&&"value"in t?t.value:t:null,a=formatExifValue(e[a]);let r=null;if(Array.isArray(t)){let i=t.map(parseRational).filter(e=>null!=e);if(3<=i.length){let[e,t,a]=i;r=e+t/60+a/3600}}else r=parseRational(t);if(null==r){let e=formatExifValue(i);return e?a&&!e.includes(a)?e+" "+a:e:null}e=a?String(a).trim().toUpperCase():"",t=Math.abs(r).toFixed(4);return e?t+" "+e:r.toFixed(4)},setExifPanelOpen=e=>{a.panel&&a.toggleButton&&(a.panel.classList.toggle("hidden",!e),a.panel.setAttribute("aria-hidden",e?"false":"true"),a.toggleButton.setAttribute("aria-expanded",e?"true":"false"))},clearExifCards=()=>{a.cardsContainer&&(a.cardsContainer.innerHTML="")},createExifCard=t=>{let e=a.cardTemplate,i=e?.content?.firstElementChild,r=i?i.cloneNode(!0):null;if(!r){(r=document.createElement("div")).className="rounded-lg border border-border-color bg-background-color-transparent-80 px-3 py-2 shadow-redefine-flat";let e=document.createElement("div"),t=(e.className="image-viewer-exif-card-header flex items-center gap-2 mb-1",document.createElement("i")),a=(t.className="image-viewer-exif-card-icon fa-solid fa-circle-info text-xs text-third-text-color",document.createElement("div")),i=(a.className="image-viewer-exif-card-title text-xs font-semibold text-first-text-color",e.appendChild(t),e.appendChild(a),document.createElement("div"));i.className="image-viewer-exif-card-items flex flex-col gap-1",r.appendChild(e),r.appendChild(i)}var l=r.querySelector(".image-viewer-exif-card-title"),n=r.querySelector(".image-viewer-exif-card-icon");let s=r.querySelector(".image-viewer-exif-card-items");if(s||((s=document.createElement("div")).className="image-viewer-exif-card-items flex flex-col gap-1",r.appendChild(s)),l&&(l.textContent=t.title),n){let e=t.icon||"fa-solid fa-circle-info";n.className=`image-viewer-exif-card-icon ${e} text-xs text-third-text-color`}return s.innerHTML="",t.items.forEach(e=>{var t,a,i;s.appendChild((t=e.label,e=e.value,(a=document.createElement("div")).className="image-viewer-exif-item flex items-start justify-between gap-2",(i=document.createElement("div")).className="image-viewer-exif-item-label text-[0.65rem] uppercase tracking-wide shrink-0 text-third-text-color",i.textContent=t,(t=document.createElement("div")).className="image-viewer-exif-item-value text-[0.65rem] text-first-text-color text-right",t.textContent=e,a.appendChild(i),a.appendChild(t),a))}),r},renderExifGroups=n=>{if(a.cardsContainer){clearExifCards();let e=Array.isArray(n)?n.map(e=>{var t,a;return e&&"object"==typeof e&&(t=String(e.title||"").trim(),a=String(e.icon||"").trim(),e=Array.isArray(e.items)?e.items.map(e=>{var t;return e&&"object"==typeof e&&(t=String(e.label||"").trim(),e=String(e.value??"").trim(),t)&&e?{label:t,value:e}:null}).filter(Boolean):[],t)&&0!==e.length?{title:t,icon:a,items:e}:null}).filter(Boolean):[],i=t("exif.title","EXIF"),r=e.length?e:[{title:i,icon:"fa-solid fa-circle-info",items:[{label:i,value:t("exif.status.no_exif","No EXIF available")}]}],l=document.createDocumentFragment();r.forEach(e=>{l.appendChild(createExifCard(e))}),a.cardsContainer.appendChild(l)}},bumpExifRequestId=()=>(a.requestId=(a.requestId||0)+1,a.requestId),renderExifMessage=e=>{var a=t("exif.title","EXIF");renderExifGroups([{title:a,icon:"fa-solid fa-circle-info",items:[{label:a,value:e}]}])},loadExifForImage=async e=>{var i=bumpExifRequestId(),r=(renderExifMessage(t("exif.status.loading","Loading...")),window.ExifReader);if(!r||"function"!=typeof r.load)return a.requestId!==i?void 0:void renderExifMessage(t("exif.status.library_missing","EXIF library not loaded"));var l,n=(e=>{if(!e)return null;var t=e.getAttribute("data-src")||e.currentSrc||e.src;if(!t)return null;try{return new URL(t,window.location.href).toString()}catch(e){return t}})(e);if(n)try{let e=await r.load(n);a.requestId===i&&(0===(l=(e=>{if(!e)return[];let i=[],a=(e,t,a)=>{a=(a||[]).filter(Boolean);0!==a.length&&i.push({title:e,icon:t,items:a})},r=getExifValueByKeys(e,["Make"]),l=getExifValueByKeys(e,["Model"]),n=getExifValueByKeys(e,["DateTimeOriginal","DateTime"]);a(t("exif.cards.camera","Camera"),"fa-solid fa-camera",[r&&{label:t("exif.fields.make","Brand"),value:r},l&&{label:t("exif.fields.model","Model"),value:l},n&&{label:t("exif.fields.date_taken","Date taken"),value:n}]);var s=getExifValueByKeys(e,["LensModel","Lens","LensSpecification"]),o=getExifValueByKeys(e,["FocalLength","FocalLengthIn35mmFilm"]),d=getExifValueByKeys(e,["FocusMode","AFMode","AFAreaMode","FocusingMode","AutoFocus","FocusMethod"]),s=(a(t("exif.cards.lens","Lens"),"fa-solid fa-eye",[s&&{label:t("exif.fields.lens_model","Lens"),value:s},o&&{label:t("exif.fields.focal_length","Focal length"),value:o},d&&{label:t("exif.fields.focus_mode","Focus mode"),value:d}]),getExifValueByKeys(e,["ExposureTime"])),o=getExifValueByKeys(e,["FNumber"]),d=getExifValueByKeys(e,["ISO","PhotographicSensitivity"]),u=getExifValueByKeys(e,["ExposureProgram"]),g=getExifValueByKeys(e,["ExposureBiasValue"]),c=getExifValueByKeys(e,["MeteringMode"]),s=(a(t("exif.cards.exposure","Exposure"),"fa-solid fa-sun",[s&&{label:t("exif.fields.shutter","Shutter"),value:s},o&&{label:t("exif.fields.aperture","Aperture"),value:o},d&&{label:t("exif.fields.iso","ISO"),value:d},u&&{label:t("exif.fields.exposure_program","Exposure program"),value:u},g&&{label:t("exif.fields.exposure_compensation","Exposure compensation"),value:g},c&&{label:t("exif.fields.metering_mode","Metering mode"),value:c}]),getExifValueByKeys(e,["Flash"])),o=getExifValueByKeys(e,["WhiteBalance"]),d=formatGpsCoordinate(e,"GPSLatitude","GPSLatitudeRef"),u=formatGpsCoordinate(e,"GPSLongitude","GPSLongitudeRef"),g=getExifValueByKeys(e,["GPSAltitude"]);return a(t("exif.cards.other","Other"),"fa-solid fa-gear",[s&&{label:t("exif.fields.flash","Flash"),value:s},o&&{label:t("exif.fields.white_balance","White balance"),value:o},d&&{label:t("exif.fields.latitude","Latitude"),value:d},u&&{label:t("exif.fields.longitude","Longitude"),value:u},g&&{label:t("exif.fields.altitude","Altitude"),value:g}]),i})(e)).length?renderExifMessage(t("exif.status.no_exif","No EXIF available")):renderExifGroups(l))}catch(e){a.requestId===i&&renderExifMessage(t("exif.status.unavailable","EXIF unavailable (blocked by CORS or missing metadata)"))}else a.requestId===i&&renderExifMessage(t("exif.status.image_source_missing","Image source unavailable"))},resetExifUI=()=>{bumpExifRequestId(),a.toggleButton&&(a.toggleButton.classList.add("hidden"),a.toggleButton.setAttribute("aria-expanded","false")),setExifPanelOpen(!1),clearExifCards()},updateViewerImage=l=>{var n=r[l];if(n&&e.targetImg){e.currentImgIndex=l;let t=n.src,i=(n.hasAttribute("lazyload")&&((t=n.getAttribute("data-src")||t)&&(n.src=t),n.removeAttribute("lazyload")),t&&(e.targetImg.src=t),e.targetImg.alt=n.alt||"",()=>{e.targetImg?.removeEventListener("load",i),fitToViewport()});e.targetImg.complete?fitToViewport():e.targetImg.addEventListener("load",i,{once:!0}),updateNavButtons();l=n;l=hasExifFlag(l),bumpExifRequestId(),a.toggleButton&&(a.toggleButton.classList.toggle("hidden",!l),a.toggleButton.disabled=!l),setExifPanelOpen(!1),clearExifCards()}},goPrev=()=>{e.isBigImage&&canGoPrev()&&updateViewerImage(e.currentImgIndex-1)},goNext=()=>{e.isBigImage&&canGoNext()&&updateViewerImage(e.currentImgIndex+1)},handleArrowKeys=t=>{if(e.isBigImage)return"Escape"===t.key?(t.preventDefault(),void closeViewer()):"ArrowUp"===t.key||"ArrowLeft"===t.key?(t.preventDefault(),void goPrev()):void("ArrowDown"!==t.key&&"ArrowRight"!==t.key||(t.preventDefault(),goNext()))};export default function initImageViewer({signal:s,appSignal:o}={}){let d=document.querySelector(".image-viewer-container");if(!d)return void console.warn("Image viewer container not found. Exiting imageViewer function.");var u=d.querySelector("img");if(!u)return void console.warn("Target image not found in image viewer container. Exiting imageViewer function.");e.maskDom=d,e.targetImg=u,e.dragged=!1,n.prevButton=d.querySelector(".image-viewer-prev"),n.nextButton=d.querySelector(".image-viewer-next"),n.closeButton=d.querySelector(".image-viewer-close"),a.toggleButton=d.querySelector(".image-viewer-exif-toggle"),a.panel=d.querySelector(".image-viewer-exif-panel"),a.cardsContainer=d.querySelector(".image-viewer-exif-cards"),a.closeButton=d.querySelector(".image-viewer-exif-close"),a.cardTemplate=d.querySelector(".image-viewer-exif-card-template"),updateImageNodes(),o=o,l||(l=!0,o?document.addEventListener("keydown",handleArrowKeys,{signal:o}):document.addEventListener("keydown",handleArrowKeys)),updateNavButtons(),resetExifUI();var o=t=>{var a,i,r,l,n;t.ctrlKey&&(t.preventDefault(),e.targetImg)&&(i=e.targetImg.getBoundingClientRect(),a=t.clientX-i.left-i.width/2,i=t.clientY-i.top-i.height/2,r=e.scale,l=Math.max(.2,.8*e.fitScale),n=Math.min(8,4*e.fitScale),e.scale+=-.001*t.deltaY,e.scale=Math.min(Math.max(l,e.scale),n),e.userZoomed=.01<Math.abs(e.scale-e.fitScale),r<e.scale?(e.translateX-=a*(e.scale-r),e.translateY-=i*(e.scale-r)):(e.translateX=0,e.translateY=0),applyTransform())},g=t=>{e.scale<=e.fitScale+.01||(t.preventDefault(),e.isMouseDown=!0,e.lastMouseX=t.clientX,e.lastMouseY=t.clientY,f=t.clientX,m=t.clientY,e.targetImg.style.cursor="grabbing",e.userZoomed=!0)};let c=null,f=null,m=null;var x=t=>{!e.isMouseDown||e.scale<=e.fitScale+.01||(f=t.clientX,m=t.clientY,null===c&&(c=window.requestAnimationFrame(()=>{var t,a;c=(null==f||null==m||(t=f-e.lastMouseX,a=m-e.lastMouseY,e.translateX+=t,e.translateY+=a,e.lastMouseX=f,e.lastMouseY=m,applyTransform(),e.dragged=!0),null)})))},v=t=>{e.isMouseDown&&t.stopPropagation(),e.isMouseDown=!1,null!==c&&(window.cancelAnimationFrame(c),c=null),f=null,m=null,e.dragged&&window.setTimeout(()=>{e.dragged=!1},0),e.targetImg.style.cursor="grab"},p=t=>{var t=t.target.closest(i);t&&!t.closest(".image-viewer-container")&&(updateImageNodes(),t=r.indexOf(t),e.isBigImage=!0,e.dragged=!1,e.userZoomed=!1,showHandle(!0),updateViewerImage(-1===t?0:t))},E=t=>{var a;e.dragged||(t=t.target).closest(".image-viewer-prev, .image-viewer-next, .image-viewer-close, .image-viewer-exif-panel, .image-viewer-exif-toggle")||!t.closest(".image-viewer-frame img")&&(a=d.querySelector(".image-viewer-frame"),t===d||a&&t===a)&&closeViewer()},y=e=>{e.stopPropagation(),goPrev()},w=e=>{e.stopPropagation(),goNext()},h=e=>{e.stopPropagation(),closeViewer()},b=i=>{i.stopPropagation(),a.panel&&(a.panel.classList.contains("hidden")?(setExifPanelOpen(!0),i=r[e.currentImgIndex],hasExifFlag(i)?loadExifForImage(i):renderExifMessage(t("exif.status.flag_unavailable","EXIF unavailable"))):setExifPanelOpen(!1))},I=e=>{e.stopPropagation(),setExifPanelOpen(!1)},B=()=>{e.isBigImage&&!e.userZoomed&&fitToViewport()};s?(u.addEventListener("wheel",o,{passive:!1,signal:s}),u.addEventListener("mousedown",g,{passive:!1,signal:s}),u.addEventListener("mousemove",x,{passive:!1,signal:s}),u.addEventListener("mouseup",v,{passive:!1,signal:s}),u.addEventListener("mouseleave",v,{passive:!1,signal:s}),d.addEventListener("click",E,{signal:s}),window.addEventListener("resize",B,{signal:s}),document.addEventListener("click",p,{signal:s}),n.prevButton?.addEventListener("click",y,{signal:s}),n.nextButton?.addEventListener("click",w,{signal:s}),n.closeButton?.addEventListener("click",h,{signal:s}),a.toggleButton?.addEventListener("click",b,{signal:s}),a.closeButton?.addEventListener("click",I,{signal:s})):(u.addEventListener("wheel",o,{passive:!1}),u.addEventListener("mousedown",g,{passive:!1}),u.addEventListener("mousemove",x,{passive:!1}),u.addEventListener("mouseup",v,{passive:!1}),u.addEventListener("mouseleave",v,{passive:!1}),d.addEventListener("click",E),window.addEventListener("resize",B),document.addEventListener("click",p),n.prevButton?.addEventListener("click",y),n.nextButton?.addEventListener("click",w),n.closeButton?.addEventListener("click",h),a.toggleButton?.addEventListener("click",b),a.closeButton?.addEventListener("click",I))}