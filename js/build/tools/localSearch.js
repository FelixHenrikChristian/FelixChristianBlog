let t=!1,e=[],n=null,o=!0,s=!1,r=!1,ensureSearchPath=()=>n||(()=>{var e=config.path;if(!e)return null;let t=e;return o=!0,0===t.length?t="search.xml":t.endsWith("json")&&(o=!1),n=t})(),fetchData=()=>{!t&&n&&fetch(config.root+n).then(e=>e.text()).then(n=>{t=!0,e=(e=o?[...(new DOMParser).parseFromString(n,"text/xml").querySelectorAll("entry")].map(e=>({title:e.querySelector("title").textContent,content:e.querySelector("content").textContent,url:e.querySelector("url").textContent})):JSON.parse(n)).filter(e=>e.title).map(e=>(e.title=e.title.trim(),e.content=e.content?e.content.trim().replace(/<[^>]+>/g,""):"",e.url=decodeURIComponent(e.url).replace(/\/{2,}/g,"/"),e));n=document.querySelector("#no-result");n&&(n.innerHTML='<i class="fa-solid fa-magnifying-glass fa-5x"></i>')}).catch(e=>{console.error("Failed to load search data:",e)})},getSearchDom=()=>({searchInputDom:document.querySelector(".search-input"),resultContent:document.getElementById("search-result"),overlay:document.querySelector(".search-pop-overlay")}),closePopup=()=>{var e=getSearchDom().overlay;e&&(document.body.style.overflow="",e.classList.remove("active"))},getIndexByWord=(e,t,n)=>{var r=e.length;if(0===r)return[];let o=0,l;var a=[];for(n||(t=t.toLowerCase(),e=e.toLowerCase());-1<(l=t.indexOf(e,o));)a.push({position:l,word:e}),o=l+r;return a},mergeIntoSlice=(e,t,n,r)=>{let o=n[n.length-1],{position:l,word:a}=o;var s=[];let i=0;for(;l+a.length<=t&&0!==n.length;){a===r&&i++,s.push({position:l,length:a.length});let t=l+a.length;n.pop();for(let e=n.length-1;0<=e&&(o=n[e],l=o.position,a=o.word,!(t<=l));e--)n.pop()}return{hits:s,start:e,end:t,searchTextCount:i}},highlightKeyword=(n,e)=>{let r="",o=e.start;return e.hits.forEach(e=>{r+=n.substring(o,e.position);var t=e.position+e.length;r+=`<b class="search-keyword">${n.substring(e.position,t)}</b>`,o=t}),r+=n.substring(o,e.end)},renderSearchResult=n=>{if(t&&n){var r=getSearchDom().resultContent;if(r){let u=n.value.trim().toLowerCase(),a=u.split(/[-\s]+/),d=(1<a.length&&a.push(u),[]);if(0<u.length&&e.forEach(({title:r,content:s,url:o})=>{let t=r.toLowerCase(),n=s.toLowerCase(),l=[],i=[],h=0;if(a.forEach(e=>{l=l.concat(getIndexByWord(e,t,!1)),i=i.concat(getIndexByWord(e,n,!1))}),0<l.length||0<i.length){let e=l.length+i.length,t=([l,i].forEach(e=>{e.sort((e,t)=>t.position!==e.position?t.position-e.position:e.word.length-t.word.length)}),[]);if(0!==l.length){let e=mergeIntoSlice(0,r.length,l,u);h+=e.searchTextCountInSlice,t.push(e)}let a=[];for(;0!==i.length;){let e=i[i.length-1],{position:t,word:n}=e,r=t-20,o=t+80,l=(r<0&&(r=0),(o=o<t+n.length?t+n.length:o)>s.length&&(o=s.length),mergeIntoSlice(r,o,i,u));h+=l.searchTextCountInSlice,a.push(l)}a.sort((e,t)=>e.searchTextCount!==t.searchTextCount?t.searchTextCount-e.searchTextCount:e.hits.length!==t.hits.length?t.hits.length-e.hits.length:e.start-t.start);var c=parseInt(theme.navbar.search.top_n_per_article||1,10);0<=c&&(a=a.slice(0,c));let n="";0!==t.length?n+=`<li><a href="${o}" class="search-result-title">${highlightKeyword(r,t[0])}</a>`:n+=`<li><a href="${o}" class="search-result-title">${r}</a>`,a.forEach(e=>{n+=`<a href="${o}"><p class="search-result">${highlightKeyword(s,e)}...</p></a>`}),n+="</li>",d.push({item:n,id:d.length,hitCount:e,searchTextCount:h})}}),1===a.length&&""===a[0])r.innerHTML='<div id="no-result"><i class="fa-solid fa-magnifying-glass fa-5x"></i></div>';else if(0===d.length)r.innerHTML='<div id="no-result"><i class="fa-solid fa-box-open fa-5x"></i></div>';else{d.sort((e,t)=>e.searchTextCount!==t.searchTextCount?t.searchTextCount-e.searchTextCount:e.hitCount!==t.hitCount?t.hitCount-e.hitCount:t.id-e.id);let t='<ul class="search-result-list">';d.forEach(e=>{t+=e.item}),t+="</ul>",r.innerHTML=t,window.pjax&&window.pjax.refresh(r)}}}},handleInput=e=>{e.target.matches(".search-input")&&renderSearchResult(e.target)},handleClick=e=>{if(e.target.closest(".search-popup-trigger")){let{overlay:e,searchInputDom:n}=getSearchDom();e&&n&&(document.body.style.overflow="hidden",e.classList.add("active"),setTimeout(()=>n.focus(),500),t||fetchData())}else{var n=e.target.closest(".search-pop-overlay");if(n&&e.target===n)closePopup();else if(e.target.closest(".search-input-field-pre")){let e=getSearchDom().searchInputDom;e&&(e.value="",e.focus(),renderSearchResult(e))}else e.target.closest(".popup-btn-close")&&closePopup()}},handleKeyup=e=>{"Escape"===e.key&&closePopup()},initLocalSearchGlobals=({signal:e}={})=>{ensureSearchPath()?s||(s=!0,e?(document.addEventListener("input",handleInput,{signal:e}),document.addEventListener("click",handleClick,{signal:e}),window.addEventListener("keyup",handleKeyup,{signal:e})):(document.addEventListener("input",handleInput),document.addEventListener("click",handleClick),window.addEventListener("keyup",handleKeyup))):r||(console.warn("`hexo-generator-searchdb` plugin is not installed!"),r=!0)},initLocalSearchPage=()=>{ensureSearchPath()?(closePopup(),theme.navbar?.search?.preload&&fetchData()):r||(console.warn("`hexo-generator-searchdb` plugin is not installed!"),r=!0)};export{initLocalSearchGlobals,initLocalSearchPage};